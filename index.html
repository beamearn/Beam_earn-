<script>
    // Firebase Configuration
    const firebaseConfig = {
        apiKey: "AIzaSyCMjUsZP-V_e-0VIHw5eI1hAvbI3bWsOqY",
        authDomain: "beam-earn.firebaseapp.com",
        databaseURL: "https://beam-earn-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "beam-earn",
        storageBucket: "beam-earn.firebasestorage.app",
        messagingSenderId: "931208618025",
        appId: "1:931208618025:web:06c593ef81ec123f4abc38"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Data Management
    let currentUser = null;
    let userData = null;
    
    // Initialize the app
    document.addEventListener('DOMContentLoaded', function() {
        setupEventListeners();
        checkAuthStatus();
        updateCountdownTimer();
        setInterval(updateCountdownTimer, 1000);
    });

    function setupEventListeners() {
        // Header login button
        document.getElementById('loginBtn').addEventListener('click', function() {
            showAuth('login');
        });

        // Dashboard register button
        document.getElementById('registerDashboardBtn').addEventListener('click', function() {
            showAuth('register');
        });

        // Dashboard login link
        document.getElementById('loginDashboardLink').addEventListener('click', function(e) {
            e.preventDefault();
            showAuth('login');
        });

        // Bottom navigation
        document.getElementById('navDashboard').addEventListener('click', function() {
            showSection('dashboard');
        });
        document.getElementById('navTasks').addEventListener('click', function() {
            showSection('tasks');
            loadDailyTasks();
        });
        document.getElementById('navWallet').addEventListener('click', function() {
            showSection('wallet');
            loadTransactionHistory();
        });
        document.getElementById('navSupport').addEventListener('click', function() {
            showSection('support');
        });

        // Quick actions
        document.getElementById('showTasksBtn').addEventListener('click', function() {
            showSection('tasks');
            loadDailyTasks();
        });
        document.getElementById('showWalletBtn').addEventListener('click', function() {
            showSection('wallet');
            loadTransactionHistory();
        });
        document.getElementById('showSupportBtn').addEventListener('click', function() {
            showSection('support');
        });

        // Level upgrade buttons
        document.getElementById('activateInternBtn').addEventListener('click', function() {
            showAuth('register');
        });
        document.getElementById('upgradeS1Btn').addEventListener('click', function() {
            showDepositModal('S1', 40000);
        });
        document.getElementById('upgradeS2Btn').addEventListener('click', function() {
            showDepositModal('S2', 200000);
        });
        document.getElementById('upgradeS3Btn').addEventListener('click', function() {
            showDepositModal('S3', 500000);
        });

        // Bonus and referral
        document.getElementById('claimBonusBtn').addEventListener('click', claimDailyBonus);
        document.getElementById('shareReferralBtn').addEventListener('click', shareReferral);

        // Wallet
        document.getElementById('withdrawBtn').addEventListener('click', processWithdrawal);

        // Support
        document.getElementById('openSupportTelegramBtn').addEventListener('click', openSupportTelegram);
        document.getElementById('sendSupportBtn').addEventListener('click', sendSupportMessage);

        // Modal close buttons
        document.getElementById('closeAuthModal').addEventListener('click', hideAuth);
        document.getElementById('closeDepositModal').addEventListener('click', hideDepositModal);

        // Close modals when clicking outside
        window.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        });
    }

    function showSection(sectionId) {
        // Hide all sections
        document.querySelectorAll('main > section').forEach(section => {
            section.classList.add('hidden');
        });
        
        // Show the selected section
        const targetSection = document.getElementById(sectionId);
        if (targetSection) {
            targetSection.classList.remove('hidden');
        }
        
        // Update bottom navigation
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
        });
        
        // Activate the corresponding nav item
        const navItems = document.querySelectorAll('.nav-item');
        const sectionMap = {
            'dashboard': 0,
            'tasks': 1,
            'wallet': 2,
            'support': 3
        };
        
        if (sectionMap[sectionId] !== undefined) {
            navItems[sectionMap[sectionId]].classList.add('active');
        }
    }

    function showAuth(type) {
        const modal = document.getElementById('authModal');
        const content = document.getElementById('authContent');
        
        if (type === 'register') {
            content.innerHTML = `
                <h3 class="text-center" style="color: var(--primary);">Join Beam Earn üöÄ</h3>
                <div class="input-group">
                    <input type="text" id="regName" class="input" placeholder="Full Name" required>
                </div>
                <div class="input-group">
                    <input type="tel" id="regPhone" class="input" placeholder="Phone Number (e.g. 0707275930)" required>
                </div>
                <div class="input-group">
                    <input type="password" id="regPassword" class="input" placeholder="Password (min 6 characters)" required>
                </div>
                <div class="input-group">
                    <input type="text" id="regReferral" class="input" placeholder="Referral Code (Optional)">
                </div>
                <button class="btn btn-primary" id="registerBtn">Create Account</button>
                <p class="text-center mt-2">
                    Already have an account? <a href="#" id="showLoginLink" style="color: var(--primary);">Login</a>
                </p>
            `;
            
            document.getElementById('registerBtn').addEventListener('click', register);
            document.getElementById('showLoginLink').addEventListener('click', function(e) {
                e.preventDefault();
                showAuth('login');
            });
        } else {
            content.innerHTML = `
                <h3 class="text-center" style="color: var(--primary);">Welcome Back! üëã</h3>
                <div class="input-group">
                    <input type="tel" id="loginPhone" class="input" placeholder="Phone Number (e.g. 0707275930)" required>
                </div>
                <div class="input-group">
                    <input type="password" id="loginPassword" class="input" placeholder="Password" required>
                </div>
                <button class="btn btn-primary" id="loginModalBtn">Login</button>
                <p class="text-center mt-2">
                    Don't have an account? <a href="#" id="showRegisterLink" style="color: var(--primary);">Register</a>
                </p>
            `;
            
            document.getElementById('loginModalBtn').addEventListener('click', login);
            document.getElementById('showRegisterLink').addEventListener('click', function(e) {
                e.preventDefault();
                showAuth('register');
            });
        }
        
        modal.style.display = 'block';
    }

    function hideAuth() {
        document.getElementById('authModal').style.display = 'none';
    }

    // Improved phone number validation and conversion
    function normalizePhoneNumber(phone) {
        // Remove all non-digit characters
        let normalized = phone.replace(/\D/g, '');
        
        // Handle different formats
        if (normalized.startsWith('0')) {
            // Convert 07... to +2567...
            normalized = '+256' + normalized.substring(1);
        } else if (normalized.startsWith('256') && normalized.length === 12) {
            // Convert 2567... to +2567...
            normalized = '+' + normalized;
        } else if (!normalized.startsWith('+') && normalized.length === 9) {
            // Assume it's a local number without country code
            normalized = '+256' + normalized;
        }
        
        return normalized;
    }

    function phoneToEmail(phone) {
        const normalizedPhone = normalizePhoneNumber(phone);
        const local = normalizedPhone.replace(/\+/g, "p").replace(/\D/g, "");
        return local + "@beam-earn.local";
    }

    // Check if phone number is valid
    function isValidPhoneNumber(phone) {
        const normalized = normalizePhoneNumber(phone);
        // Check if it's a valid Ugandan number
        const ugandanRegex = /^\+256(7[0-9]|20|3[0-9]|4[0-9]|5[0-9]|6[0-9]|8[0-9]|9[0-9])[0-9]{6,7}$/;
        return ugandanRegex.test(normalized);
    }

    async function register() {
        const name = document.getElementById('regName').value;
        const phone = document.getElementById('regPhone').value;
        const password = document.getElementById('regPassword').value;
        const referralCode = document.getElementById('regReferral').value.toUpperCase().trim();

        if (!name || !phone || !password) {
            alert('Please fill all required fields!');
            return;
        }

        if (password.length < 6) {
            alert('Password must be at least 6 characters long!');
            return;
        }

        // Validate phone number
        if (!isValidPhoneNumber(phone)) {
            alert('Please enter a valid Ugandan phone number (e.g. 0707275930, 256707275930, or +256707275930)');
            return;
        }

        try {
            // Convert phone to email format
            const email = phoneToEmail(phone);
            
            console.log('Attempting to create user with email:', email);
            
            // Create Firebase Auth user
            const userCredential = await auth.createUserWithEmailAndPassword(email, password);
            const user = userCredential.user;

            console.log('Auth user created successfully:', user.uid);

            // Generate referral code
            const userReferralCode = generateReferralCode();
            
            // Create user data for Firestore
            const newUserData = {
                id: user.uid,
                name: name,
                phone: phone,
                normalizedPhone: normalizePhoneNumber(phone),
                email: email,
                referralCode: userReferralCode,
                referredBy: referralCode || null,
                level: 'intern',
                balance: 25,
                referralEarnings: 0,
                referralCount: 0,
                totalEarned: 25,
                internStartDate: new Date().toISOString(),
                internDaysLeft: 2,
                tasksCompleted: 0,
                joinedDate: new Date().toISOString(),
                lastActive: new Date().toISOString(),
                lastBonusClaim: '',
                lastTaskDate: '',
                dailyQuestionsCompleted: 0,
                dailyQuestionsLimit: 2,
                isActive: true
            };

            console.log('Saving user data to Firestore...');

            // Save user data to Firestore
            await db.collection('users').doc(user.uid).set(newUserData);
            console.log('User data saved to Firestore successfully');

            // If referral code was provided, update referrer's count
            if (referralCode && referralCode !== '') {
                console.log('Processing referral code:', referralCode);
                await updateReferrerCount(referralCode, user.uid, name);
            }
            
            alert('Welcome to Beam Earn! üéâ You have 2 days FREE intern access!');
            hideAuth();
            
        } catch (error) {
            console.error('Registration error:', error);
            if (error.code === 'auth/email-already-in-use') {
                alert('This phone number is already registered. Please login or use a different phone number.');
            } else if (error.code === 'auth/network-request-failed') {
                alert('Network error. Please check your internet connection and try again.');
            } else {
                alert('Error creating account: ' + error.message);
            }
        }
    }

    // FIXED FUNCTION: Update referrer's count when someone uses their referral code
    async function updateReferrerCount(referralCode, newUserId, newUserName) {
        try {
            console.log('Looking for referrer with code:', referralCode);
            
            // Find the user with this referral code
            const referrerQuery = await db.collection('users').where('referralCode', '==', referralCode).get();
            
            if (!referrerQuery.empty) {
                const referrerDoc = referrerQuery.docs[0];
                const referrerData = referrerDoc.data();
                
                console.log('Found referrer:', referrerData.name);
                
                // Update referrer's count and earnings
                const newReferralCount = (referrerData.referralCount || 0) + 1;
                const referralBonus = 50;
                const newBalance = Number(referrerData.balance || 0) + referralBonus;
                const newReferralEarnings = Number(referrerData.referralEarnings || 0) + referralBonus;
                
                console.log('Updating referrer:', {
                    currentBalance: referrerData.balance,
                    newBalance: newBalance,
                    currentCount: referrerData.referralCount,
                    newCount: newReferralCount
                });

                // Update referrer's document
                await db.collection('users').doc(referrerDoc.id).update({
                    referralCount: newReferralCount,
                    balance: newBalance,
                    referralEarnings: newReferralEarnings,
                    lastActive: new Date().toISOString()
                });
                
                console.log('Referrer updated successfully');
                
                // Add transaction record for referrer
                const transactionData = {
                    userId: referrerDoc.id,
                    type: 'referral',
                    amount: referralBonus,
                    description: `Referral bonus from ${newUserName}`,
                    date: new Date().toISOString(),
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };
                await db.collection('transactions').add(transactionData);
                
                console.log('Referral transaction added');
                
            } else {
                console.log('No referrer found with code:', referralCode);
            }
        } catch (error) {
            console.error('Error updating referrer count:', error);
        }
    }

    async function login() {
        const phone = document.getElementById('loginPhone').value;
        const password = document.getElementById('loginPassword').value;

        if (!phone || !password) {
            alert('Please enter both phone number and password!');
            return;
        }

        // Validate phone number
        if (!isValidPhoneNumber(phone)) {
            alert('Please enter a valid Ugandan phone number (e.g. 0707275930, 256707275930, or +256707275930)');
            return;
        }

        try {
            // Convert phone to email format
            const email = phoneToEmail(phone);
            
            console.log('Attempting login with email:', email);
            
            const userCredential = await auth.signInWithEmailAndPassword(email, password);
            const user = userCredential.user;
            
            console.log('Login successful for user:', user.uid);

            // Update last active timestamp
            await db.collection('users').doc(user.uid).update({
                lastActive: new Date().toISOString()
            });

            alert(`Welcome back! üëã`);
            hideAuth();
            
        } catch (error) {
            console.error('Login error:', error);
            if (error.code === 'auth/user-not-found') {
                alert('No account found with this phone number. Please register first.');
            } else if (error.code === 'auth/wrong-password') {
                alert('Invalid password. Please try again.');
            } else if (error.code === 'auth/network-request-failed') {
                alert('Network error. Please check your internet connection and try again.');
            } else {
                alert('Invalid phone number or password!');
            }
        }
    }

    function checkAuthStatus() {
        auth.onAuthStateChanged(async (user) => {
            const registerPrompt = document.getElementById('registerPrompt');
            const userStats = document.getElementById('userStats');
            const referralSection = document.getElementById('referralSection');
            const dailyBonusSection = document.getElementById('dailyBonusSection');
            const internCountdown = document.getElementById('internCountdown');
            const navAuth = document.querySelector('.nav-auth');

            if (user) {
                // User is signed in
                currentUser = user;
                
                console.log('User authenticated:', user.uid);
                
                // Load user data from Firestore
                try {
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    if (userDoc.exists) {
                        userData = userDoc.data();
                        console.log('User data loaded from Firestore:', userData);
                        updateUIForLoggedInUser();
                    } else {
                        console.log('No user data found in Firestore');
                        alert('User profile not found. Please contact support.');
                        await auth.signOut();
                        return;
                    }
                } catch (error) {
                    console.error('Error loading user data:', error);
                    alert('Error loading your profile. Please check your connection and try again.');
                    return;
                }

                registerPrompt.classList.add('hidden');
                userStats.classList.remove('hidden');
                referralSection.classList.remove('hidden');
                dailyBonusSection.classList.remove('hidden');
                
                if (userData && userData.level === 'intern') {
                    internCountdown.classList.remove('hidden');
                } else {
                    internCountdown.classList.add('hidden');
                }
                
                navAuth.innerHTML = `
                    <span style="margin-right: 1rem; color: var(--primary); font-weight: 600;">Hi, ${userData?.name || 'User'}</span>
                    <button class="btn btn-warning" id="logoutBtn" style="padding: 8px 15px; width: auto;">Logout</button>
                `;
                document.getElementById('logoutBtn').addEventListener('click', logout);
                
            } else {
                // User is signed out
                currentUser = null;
                userData = null;
                
                registerPrompt.classList.remove('hidden');
                userStats.classList.add('hidden');
                referralSection.classList.add('hidden');
                dailyBonusSection.classList.add('hidden');
                internCountdown.classList.add('hidden');
                
                navAuth.innerHTML = `
                    <button class="btn btn-primary" id="loginBtnHeader" style="padding: 10px 20px; width: auto;">Login</button>
                `;
                document.getElementById('loginBtnHeader').addEventListener('click', function() {
                    showAuth('login');
                });
            }
        });
    }

    function updateUIForLoggedInUser() {
        if (!userData) return;
        
        console.log('Updating UI with user data:', userData);
        
        // Ensure all values are numbers
        const balance = Number(userData.balance || 0);
        const referralEarnings = Number(userData.referralEarnings || 0);
        const referralCount = Number(userData.referralCount || 0);
        
        document.getElementById('availableBalance').textContent = balance.toLocaleString() + ' UGX';
        document.getElementById('vipLevel').textContent = (userData.level || 'intern').toUpperCase();
        document.getElementById('referralCount').textContent = referralCount;
        document.getElementById('referralEarnings').textContent = referralEarnings.toLocaleString() + ' UGX';
        document.getElementById('walletBalance').textContent = balance.toLocaleString() + ' UGX';
        document.getElementById('walletReferral').textContent = referralEarnings.toLocaleString() + ' UGX';
        document.getElementById('userReferralCode').textContent = userData.referralCode || 'ERROR';
        
        // Update bonus section
        const today = new Date().toDateString();
        const lastClaimDate = userData.lastBonusClaim || '';
        const bonusBtn = document.getElementById('claimBonusBtn');
        const bonusStatus = document.getElementById('bonusStatus');
        
        if (lastClaimDate === today) {
            bonusBtn.disabled = true;
            bonusBtn.innerHTML = '‚úÖ Bonus Claimed Today';
            bonusStatus.innerHTML = 'Come back tomorrow for your next bonus!';
        } else {
            bonusBtn.disabled = false;
            bonusBtn.innerHTML = 'üéØ Claim Your 25 UGX!';
            bonusStatus.innerHTML = '';
        }
        
        // Auto-upgrade if user has 50+ referrals and is intern
        if (userData.level === 'intern' && referralCount >= 50) {
            upgradeUserLevel('S1');
        }
    }

    async function upgradeUserLevel(newLevel) {
        if (!currentUser) return;
        
        try {
            await db.collection('users').doc(currentUser.uid).update({
                level: newLevel.toLowerCase()
            });
            
            // Update local userData
            userData.level = newLevel.toLowerCase();
            
            alert(`üéâ Congratulations! You have been upgraded to ${newLevel} level!`);
            updateUIForLoggedInUser();
        } catch (error) {
            console.error('Error upgrading user level:', error);
        }
    }

    // FIXED: Daily bonus claim with proper number handling
    async function claimDailyBonus() {
        if (!currentUser || !userData) {
            alert('Please login first!');
            return;
        }
        
        const today = new Date().toDateString();
        const lastClaimDate = userData.lastBonusClaim || '';
        
        if (lastClaimDate === today) {
            alert('You have already claimed your daily bonus today!');
            return;
        }
        
        const currentBalance = Number(userData.balance || 0);
        const currentTotalEarned = Number(userData.totalEarned || 0);
        
        const newBalance = currentBalance + 25;
        const newTotalEarned = currentTotalEarned + 25;
        
        try {
            await db.collection('users').doc(currentUser.uid).update({
                balance: newBalance,
                totalEarned: newTotalEarned,
                lastBonusClaim: today
            });
            
            // Add transaction record
            const transactionData = {
                userId: currentUser.uid,
                type: 'bonus',
                amount: 25,
                description: 'Daily login bonus',
                date: new Date().toISOString(),
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };
            await db.collection('transactions').add(transactionData);
            
            // Update local userData
            userData.balance = newBalance;
            userData.totalEarned = newTotalEarned;
            userData.lastBonusClaim = today;
            
            alert('üéâ Daily bonus claimed! 25 UGX added to your balance!');
            updateUIForLoggedInUser();
        } catch (error) {
            console.error('Error claiming bonus:', error);
            alert('Error claiming bonus. Please try again.');
        }
    }

    // FIXED: Answer checking with proper number handling
    async function checkAnswer(questionId, selectedAnswer, button) {
        if (!currentUser || !userData) return;
        
        const options = button.parentElement.querySelectorAll('.option-btn');
        
        // Disable all buttons
        options.forEach(btn => {
            btn.disabled = true;
        });
        
        // Mark selected answer
        button.classList.add('selected');
        
        // Calculate reward based on user level
        const reward = getEarningsPerQuestion(userData.level);
        
        // Update user balance - ALL ANSWERS ARE CORRECT
        const currentBalance = Number(userData.balance || 0);
        const currentTotalEarned = Number(userData.totalEarned || 0);
        
        const newBalance = currentBalance + reward;
        const newTotalEarned = currentTotalEarned + reward;
        const newDailyQuestionsCompleted = (userData.dailyQuestionsCompleted || 0) + 1;
        const newTasksCompleted = (userData.tasksCompleted || 0) + 1;
        
        try {
            // Update user data in Firestore
            await db.collection('users').doc(currentUser.uid).update({
                balance: newBalance,
                totalEarned: newTotalEarned,
                dailyQuestionsCompleted: newDailyQuestionsCompleted,
                tasksCompleted: newTasksCompleted
            });
            
            // Add transaction record
            const transactionData = {
                userId: currentUser.uid,
                type: 'task',
                amount: reward,
                description: 'Completed question',
                date: new Date().toISOString(),
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };
            await db.collection('transactions').add(transactionData);
            
            // Update local userData
            userData.balance = newBalance;
            userData.totalEarned = newTotalEarned;
            userData.dailyQuestionsCompleted = newDailyQuestionsCompleted;
            userData.tasksCompleted = newTasksCompleted;
            
            // Show success message
            setTimeout(() => {
                alert(`‚úÖ Answer submitted! You earned ${reward} UGX!`);
                loadDailyTasks(); // Reload tasks
                updateUIForLoggedInUser(); // Update balance display
            }, 500);
            
        } catch (error) {
            console.error('Error updating user data:', error);
            alert('Error submitting answer. Please try again.');
        }
    }

    // FIXED: Withdrawal with proper number handling
    async function processWithdrawal() {
        if (!currentUser || !userData) {
            alert('Please login first!');
            return;
        }
        
        const amount = parseInt(document.getElementById('withdrawAmount').value);
        const method = document.getElementById('withdrawMethod').value;
        const phone = document.getElementById('withdrawPhone').value;
        
        if (!amount || amount < 50000 || amount > 500000) {
            alert('Withdrawal amount must be between 50,000 UGX and 500,000 UGX');
            return;
        }
        
        const currentBalance = Number(userData.balance || 0);
        
        if (amount > currentBalance) {
            alert('Insufficient balance!');
            return;
        }
        
        if (!phone || phone.length < 10) {
            alert('Please enter a valid phone number');
            return;
        }
        
        // Check withdrawal hours (9 AM - 10 PM)
        const now = new Date();
        const currentHour = now.getHours();
        if (currentHour < 9 || currentHour >= 22) {
            alert('Withdrawals are only available between 9:00 AM and 10:00 PM');
            return;
        }
        
        const tax = Math.floor(amount * (1000 / 5000));
        const netAmount = amount - tax;
        const newBalance = currentBalance - amount;
        
        try {
            // Update user balance in Firestore
            await db.collection('users').doc(currentUser.uid).update({
                balance: newBalance
            });
            
            // Add withdrawal record
            const withdrawalData = {
                userId: currentUser.uid,
                userName: userData.name,
                userPhone: userData.phone,
                type: 'withdrawal',
                amount: amount,
                method: method,
                phone: phone,
                tax: tax,
                netAmount: netAmount,
                status: 'pending',
                date: new Date().toISOString(),
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };
            await db.collection('withdrawals').add(withdrawalData);
            
            // Add transaction record
            const transactionData = {
                userId: currentUser.uid,
                type: 'withdrawal',
                amount: -amount,
                description: `Withdrawal to ${method} (${phone}) - Tax: ${tax} UGX`,
                date: new Date().toISOString(),
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };
            await db.collection('transactions').add(transactionData);
            
            // Update local userData
            userData.balance = newBalance;
            
            alert(`Withdrawal request of ${amount.toLocaleString()} UGX submitted! üí∏\nTax: ${tax} UGX\nYou'll receive: ${netAmount.toLocaleString()} UGX\nProcessing time: 24 hours`);
            updateUIForLoggedInUser();
            loadTransactionHistory();
            
            document.getElementById('withdrawAmount').value = '';
            document.getElementById('withdrawPhone').value = '';
            
        } catch (error) {
            console.error('Error processing withdrawal:', error);
            alert('Error processing withdrawal. Please try again.');
        }
    }

    // Rest of your functions remain the same but with proper number handling...
    function shareReferral() {
        if (!userData) return;
        
        const message = `Join Beam Earn and start earning money daily! Use my referral code: ${userData.referralCode}. Earn 1,000 UGX daily for FREE! üöÄ`;
        
        if (navigator.share) {
            navigator.share({
                title: 'Join Beam Earn',
                text: message,
                url: window.location.href
            });
        } else {
            navigator.clipboard.writeText(message).then(() => {
                alert('Referral message copied to clipboard! üìã');
            });
        }
    }

    async function loadDailyTasks() {
        if (!currentUser || !userData) {
            alert('Please login first!');
            showSection('dashboard');
            return;
        }
        
        const tasksContainer = document.getElementById('tasksContainer');
        const dailyTaskStatus = document.getElementById('dailyTaskStatus');
        
        // Check if it's a new day
        const today = new Date().toDateString();
        if (userData.lastTaskDate !== today) {
            try {
                await db.collection('users').doc(currentUser.uid).update({
                    dailyQuestionsCompleted: 0,
                    lastTaskDate: today
                });
                userData.dailyQuestionsCompleted = 0;
                userData.lastTaskDate = today;
            } catch (error) {
                console.error('Error resetting daily tasks:', error);
            }
        }
        
        // Get user's daily question limit based on level
        let dailyLimit = 2;
        switch(userData.level) {
            case 'S1': dailyLimit = 4; break;
            case 'S2': dailyLimit = 8; break;
            case 'S3': dailyLimit = 12; break;
        }
        
        // Update status display
        dailyTaskStatus.innerHTML = `
            <p>Questions Completed Today: ${userData.dailyQuestionsCompleted || 0}/${dailyLimit}</p>
            <p>Earnings Per Question: ${getEarningsPerQuestion(userData.level)} UGX</p>
        `;
        
        // Check if user has completed all daily questions
        if ((userData.dailyQuestionsCompleted || 0) >= dailyLimit) {
            tasksContainer.innerHTML = `
                <div class="card text-center">
                    <h3 style="color: var(--success);">üéâ All Questions Completed!</h3>
                    <p>You've completed all ${dailyLimit} questions for today.</p>
                    <p>Come back tomorrow for more earning opportunities!</p>
                </div>
            `;
            return;
        }
        
        // Get random questions
        const questions = generateQuestions();
        const randomQuestions = getRandomQuestions(questions, dailyLimit - (userData.dailyQuestionsCompleted || 0));
        
        // Display questions
        tasksContainer.innerHTML = '';
        randomQuestions.forEach((question, index) => {
            const questionCard = document.createElement('div');
            questionCard.className = 'question-card';
            questionCard.innerHTML = `
                <div class="question-text">${index + 1}. ${question.question}</div>
                <div class="options-container">
                    ${question.options.map((option, i) => `
                        <button class="option-btn" data-question-id="${question.id}" data-answer="${i}">
                            ${option}
                        </button>
                    `).join('')}
                </div>
            `;
            tasksContainer.appendChild(questionCard);
        });
        
        // Add event listeners to option buttons
        document.querySelectorAll('.option-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const questionId = this.getAttribute('data-question-id');
                const selectedAnswer = parseInt(this.getAttribute('data-answer'));
                checkAnswer(questionId, selectedAnswer, this);
            });
        });
    }

    function getRandomQuestions(questions, count) {
        const shuffled = [...questions].sort(() => 0.5 - Math.random());
        return shuffled.slice(0, count);
    }

    function getEarningsPerQuestion(level) {
        switch(level) {
            case 'intern': return 500; // 1000 UGX / 2 questions
            case 'S1': return 347; // 1388 UGX / 4 questions
            case 'S2': return 602; // 4816 UGX / 8 questions
            case 'S3': return 809; // 9708 UGX / 12 questions
            default: return 500;
        }
    }

    async function loadTransactionHistory() {
        if (!currentUser) return;
        
        const transactionList = document.getElementById('transactionList');
        
        try {
            const transactionsSnapshot = await db.collection('transactions')
                .where('userId', '==', currentUser.uid)
                .orderBy('timestamp', 'desc')
                .limit(10)
                .get();
            
            if (transactionsSnapshot.empty) {
                transactionList.innerHTML = '<p class="text-center">No transactions yet</p>';
                return;
            }
            
            transactionList.innerHTML = transactionsSnapshot.docs.map(doc => {
                const transaction = doc.data();
                return `
                    <div class="transaction-item">
                        <div>
                            <div style="font-weight: bold;">${transaction.description}</div>
                            <div style="font-size: 0.8rem; color: #666;">${new Date(transaction.date).toLocaleDateString()}</div>
                        </div>
                        <div class="transaction-amount ${transaction.amount > 0 ? 'positive' : 'negative'}">
                            ${transaction.amount > 0 ? '+' : ''}${transaction.amount.toLocaleString()} UGX
                        </div>
                    </div>
                `;
            }).join('');
        } catch (error) {
            console.error('Error loading transactions:', error);
            transactionList.innerHTML = '<p class="text-center">Error loading transactions</p>';
        }
    }

    function openSupportTelegram() {
        window.open('https://t.me/Beam_earn', '_blank');
    }

    async function sendSupportMessage() {
        if (!currentUser || !userData) {
            alert('Please login first!');
            return;
        }
        
        const name = document.getElementById('supportName').value || userData.name;
        const phone = document.getElementById('supportPhone').value || userData.phone;
        const message = document.getElementById('supportMessage').value;
        
        if (!message) {
            alert('Please enter your message');
            return;
        }
        
        try {
            const supportData = {
                userId: currentUser.uid,
                userName: name,
                userPhone: phone,
                message: message,
                status: 'new',
                date: new Date().toISOString(),
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            await db.collection('supportTickets').add(supportData);
            
            alert('Support message sent! We will respond within 2 hours. ‚ú®');
            document.getElementById('supportName').value = '';
            document.getElementById('supportPhone').value = '';
            document.getElementById('supportMessage').value = '';
        } catch (error) {
            console.error('Error sending support message:', error);
            alert('Error sending message. Please try again.');
        }
    }

    function updateCountdownTimer() {
        if (!userData || userData.level !== 'intern') return;
        
        const startDate = new Date(userData.internStartDate);
        const endDate = new Date(startDate);
        endDate.setDate(startDate.getDate() + 2);
        
        const now = new Date();
        const diff = endDate - now;
        
        if (diff <= 0) {
            document.getElementById('countdownDisplay').textContent = 'Intern period expired!';
            return;
        }
        
        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((diff % (1000 * 60)) / 1000);
        
        document.getElementById('countdownDisplay').textContent = 
            `${days} days ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    function logout() {
        auth.signOut().then(() => {
            currentUser = null;
            userData = null;
            alert('Logged out successfully! üëã');
            showSection('dashboard');
        }).catch((error) => {
            console.error('Logout error:', error);
        });
    }

    function generateReferralCode() {
        return Math.random().toString(36).substring(2, 8).toUpperCase();
    }

    function generateQuestions() {
        const questionList = [
            {
                id: '1',
                question: 'What is the capital of Uganda?',
                options: ['Kampala', 'Nairobi', 'Kigali', 'Dar es Salaam'],
                correctAnswer: 0
            },
            {
                id: '2',
                question: 'Which company developed the Android operating system?',
                options: ['Apple', 'Microsoft', 'Google', 'Samsung'],
                correctAnswer: 2
            },
            {
                id: '3',
                question: 'What is the largest planet in our solar system?',
                options: ['Earth', 'Mars', 'Jupiter', 'Saturn'],
                correctAnswer: 2
            },
            {
                id: '4',
                question: 'Which year did Uganda gain independence?',
                options: ['1960', '1962', '1964', '1966'],
                correctAnswer: 1
            },
            {
                id: '5',
                question: 'What is the main ingredient in guacamole?',
                options: ['Tomato', 'Avocado', 'Onion', 'Pepper'],
                correctAnswer: 1
            }
        ];
        
        // Generate more questions to reach 50
        for (let i = 6; i <= 50; i++) {
            questionList.push({
                id: i.toString(),
                question: `General Knowledge Question ${i}`,
                options: ['Option A', 'Option B', 'Option C', 'Option D'],
                correctAnswer: Math.floor(Math.random() * 4)
            });
        }
        
        return questionList;
    }

    // Add the showDepositModal and related payment functions
    function showDepositModal(level, amount) {
        if (!currentUser) {
            alert('Please login first!');
            return;
        }
        
        const modal = document.getElementById('depositModal');
        const content = document.getElementById('depositContent');
        
        content.innerHTML = `
            <h3 class="text-center" style="color: var(--primary);">Upgrade to ${level} üí´</h3>
            <p class="text-center">Investment Amount: <strong>${amount.toLocaleString()} UGX</strong></p>
            
            <!-- UPDATED COMPACT MERCHANT CODE DISPLAY -->
            <div class="merchant-code-display">
                <div class="merchant-code-title">üè™ Merchant Code</div>
                <div class="merchant-code-value">6911104</div>
                <p style="color: #856404; margin-top: 10px; font-size: 0.9rem;">Use this code for both Airtel Money and MTN Mobile Money payments</p>
            </div>

            <div class="payment-method-tabs">
                <div class="payment-tab active" id="airtelTab">
                    üì± Airtel Money
                </div>
                <div class="payment-tab" id="mtnTab">
                     MTN Money
                </div>
            </div>

            <!-- UPDATED PAYMENT INSTRUCTIONS WITH COMPACT STEPS -->
            <div id="airtelInstructions" class="payment-instructions active">
                <h4>üì± How to Pay via Airtel Money:</h4>
                
                <div class="payment-step">
                    <div class="step-number">1</div>
                    <div class="step-text">Dial <span class="step-highlight">*185#</span></div>
                </div>
                
                <div class="payment-step">
                    <div class="step-number">2</div>
                    <div class="step-text">Choose option <span class="step-highlight">4 ‚Äì Payments</span></div>
                </div>
                
                <div class="payment-step">
                    <div class="step-number">3</div>
                    <div class="step-text">Choose option <span class="step-highlight">1 ‚Äì Goods and Services</span></div>
                </div>
                
                <div class="payment-step">
                    <div class="step-number">4</div>
                    <div class="step-text">Enter the Merchant Code: <span class="step-highlight">6911104</span></div>
                </div>
                
                <div class="payment-step">
                    <div class="step-number">5</div>
                    <div class="step-text">Enter the Amount: <span class="step-highlight">${amount.toLocaleString()} UGX</span></div>
                </div>
                
                <div class="payment-step">
                    <div class="step-number">6</div>
                    <div class="step-text">Enter Reference <span class="step-highlight">(if asked)</span></div>
                </div>
                
                <div class="payment-step">
                    <div class="step-number">7</div>
                    <div class="step-text">Enter your <span class="step-highlight">PIN to confirm</span></div>
                </div>
                
                <div style="background: #d4edda; color: #155724; padding: 10px; border-radius: 8px; margin-top: 10px; text-align: center; font-weight: bold; font-size: 0.9rem;">
                    ‚úÖ You'll get a confirmation SMS right after.
                </div>
            </div>

            <div id="mtnInstructions" class="payment-instructions">
                <h4>üíõ How to Pay via MTN Mobile Money:</h4>
                
                <div class="payment-step">
                    <div class="step-number">1</div>
                    <div class="step-text">Dial <span class="step-highlight">*165#</span></div>
                </div>
                
                <div class="payment-step">
                    <div class="step-number">2</div>
                    <div class="step-text">Choose option <span class="step-highlight">3 ‚Äì Payments</span></div>
                </div>
                
                <div class="payment-step">
                    <div class="step-number">3</div>
                    <div class="step-text">Choose option <span class="step-highlight">1 ‚Äì Goods and Services</span></div>
                </div>
                
                <div class="payment-step">
                    <div class="step-number">4</div>
                    <div class="step-text">Enter the Merchant Code: <span class="step-highlight">6911104</span></div>
                </div>
                
                <div class="payment-step">
                    <div class="step-number">5</div>
                    <div class="step-text">Enter the Amount: <span class="step-highlight">${amount.toLocaleString()} UGX</span></div>
                </div>
                
                <div class="payment-step">
                    <div class="step-number">6</div>
                    <div class="step-text">Enter Reference <span class="step-highlight">(reason or your name)</span></div>
                </div>
                
                <div class="payment-step">
                    <div class="step-number">7</div>
                    <div class="step-text">Enter your <span class="step-highlight">PIN to confirm</span></div>
                </div>
                
                <div style="background: #d4edda; color: #155724; padding: 10px; border-radius: 8px; margin-top: 10px; text-align: center; font-weight: bold; font-size: 0.9rem;">
                    ‚úÖ You'll get an SMS confirming payment.
                </div>
            </div>

            <div class="input-group">
                <input type="text" id="transactionId" class="input" placeholder="Enter Transaction ID from SMS">
            </div>

            <div class="paid-button-container">
                <button type="button" class="btn btn-success" id="submitPaymentBtn" 
                        style="padding: 15px; font-size: 16px; font-weight: bold;">
                    ‚úÖ I HAVE PAID - VERIFY MY PAYMENT
                </button>
                <p style="text-align: center; margin-top: 10px; color: #666; font-size: 0.9rem;">
                    Click after completing your payment to notify admin
                </p>
            </div>
            
            <div class="text-center mt-2">
                <button class="btn btn-warning" id="supportHelpBtn" style="font-size: 0.9rem;">üìû Need Help? Contact Support</button>
            </div>
        `;
        
        modal.style.display = 'block';
        
        // Add event listeners for dynamic content
        document.getElementById('airtelTab').addEventListener('click', function() {
            switchPaymentMethod('airtel');
        });
        document.getElementById('mtnTab').addEventListener('click', function() {
            switchPaymentMethod('mtn');
        });
        document.getElementById('submitPaymentBtn').addEventListener('click', function() {
            submitPayment(level, amount);
        });
        document.getElementById('supportHelpBtn').addEventListener('click', openSupportTelegram);
    }

    function switchPaymentMethod(method) {
        document.querySelectorAll('.payment-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelectorAll('.payment-instructions').forEach(instruction => {
            instruction.classList.remove('active');
        });
        
        if (method === 'airtel') {
            document.getElementById('airtelTab').classList.add('active');
            document.getElementById('airtelInstructions').classList.add('active');
        } else {
            document.getElementById('mtnTab').classList.add('active');
            document.getElementById('mtnInstructions').classList.add('active');
        }
    }

    function hideDepositModal() {
        document.getElementById('depositModal').style.display = 'none';
    }

    async function submitPayment(level, amount) {
        if (!currentUser) return;
        
        const transactionId = document.getElementById('transactionId').value;
        
        if (!transactionId) {
            alert('Please enter your transaction ID from the SMS confirmation');
            return;
        }
        
        try {
            // Create payment record in Firestore
            const paymentData = {
                userId: currentUser.uid,
                userName: userData.name,
                userPhone: userData.phone,
                level: level,
                amount: amount,
                transactionId: transactionId,
                status: 'pending',
                date: new Date().toISOString(),
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            await db.collection('payments').add(paymentData);

            alert(`Payment submitted for ${level} level! We will verify your payment and upgrade your account within 24 hours.`);
            hideDepositModal();
        } catch (error) {
            console.error('Error submitting payment:', error);
            alert('Error submitting payment. Please try again.');
        }
    }
</script>
